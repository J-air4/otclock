<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Therapy Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            .printable-area, .printable-area * {
                visibility: visible;
                background: white !important;
                color: black !important;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print { display: none; }
            .border, .border-gray-700 { border-color: #ccc !important; }
            .text-yellow-400 { color: #f59e0b !important; }
            .text-green-400 { color: #10b981 !important; }
            .bg-yellow-500\/20 { background-color: rgba(234, 179, 8, 0.2) !important; }
            .bg-blue-500\/20 { background-color: rgba(59, 130, 246, 0.2) !important; }
            .bg-green-500\/20 { background-color: rgba(16, 185, 129, 0.2) !important; }
            .bg-purple-500\/20 { background-color: rgba(139, 92, 246, 0.2) !important; }
        }
        @keyframes fade-in-down {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-down { animation: fade-in-down 0.3s ease-out forwards; }
        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-900">
    <div id="app-root"></div>

    <script type="module">
        // --- CONSTANTS ---
        const MINIMUM_SCHEDULABLE_DURATION = 15;

        // --- ICONS (SVG Strings) ---
        const icons = {
            Clock: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
            Plus: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>`,
            Trash2: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`,
            Calendar: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>`,
            AlertCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>`,
            CheckCircle: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`,
            Coffee: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/></svg>`,
            TrendingUp: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>`,
            Save: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
            Briefcase: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
            BrainCircuit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.993.142"/><path d="M12 5a3 3 0 1 1 5.993.142"/><path d="M15 13a3 3 0 1 0-5.993.142"/><path d="M15 13a3 3 0 1 1 5.993.142"/><path d="M9 13a3 3 0 1 1 5.993.142"/><path d="M9 13a3 3 0 1 0-5.993.142"/><path d="M6 8.5A2.5 2.5 0 0 1 3.5 6v0A2.5 2.5 0 0 1 6 3.5V0"/><path d="M18 8.5A2.5 2.5 0 0 0 20.5 6v0A2.5 2.5 0 0 0 18 3.5V0"/><path d="M9 22a2.5 2.5 0 0 0 2.5-2.5v-1A2.5 2.5 0 0 0 9 16h0a2.5 2.5 0 0 0-2.5 2.5v1A2.5 2.5 0 0 0 9 22Z"/><path d="M15 22a2.5 2.5 0 0 1-2.5-2.5v-1A2.5 2.5 0 0 1 15 16h0a2.5 2.5 0 0 1 2.5 2.5v1A2.5 2.5 0 0 1 15 22Z"/><path d="M12 13a2.5 2.5 0 0 0 2.5-2.5v-1A2.5 2.5 0 0 0 12 7h0a2.5 2.5 0 0 0-2.5 2.5v1A2.5 2.5 0 0 0 12 13Z"/><path d="M12 5.5V7"/><path d="M15 13v-1.5"/><path d="M9 13v-1.5"/><path d="M18 8.5v1"/><path d="M6 8.5v1"/></svg>`,
            Printer: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>`,
            X: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></svg>`,
            Zap: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`,
            Edit: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`,
        };

        const getIcon = (name, size = 16) => {
            const svg = icons[name] || '';
            return svg.replace('width="24"', `width="${size}"`).replace('height="24"', `height="${size}"`);
        }

        // --- GLOBAL STATE ---
        const state = {
            settings: {
                workDay: { startTime: '08:30' },
                breaks: [{ id: 'break-1', start: '12:00', end: '12:30', label: 'Lunch' }],
                otherTasks: [{ id: 'task-1', start: '14:00', end: '14:30', label: 'Documentation', type: 'non-billable' }],
                transitionTime: 2,
                setupTime: 5,
                productivityTarget: 93,
                workdayDurationHours: 12,
            },
            appointments: [],
            patientQueue: [],
            schedule: null,
            notification: { message: '', type: '' },
            isClearModalOpen: false,
            isEditModalOpen: false,
            editingAppointment: null,
            draggedPatient: null,
            patientCounter: 1,
            productivityCalculator: {
                extraMinutes: '',
                endTime: '17:00'
            }
        };

        // --- HELPER FUNCTIONS ---
        const timeToMinutes = (time, period) => {
            if (!time) return 0;
            const [hours, minutes] = time.split(':').map(Number);
            if (isNaN(hours) || isNaN(minutes)) return 0;
            let totalHours = hours;
            if (period === 'PM' && hours !== 12) totalHours += 12;
            else if (period === 'AM' && hours === 12) totalHours = 0; // Midnight case
            return totalHours * 60 + minutes;
        };

        const minutesToTime = (totalMinutes) => {
            if (isNaN(totalMinutes) || totalMinutes < 0) return 'Invalid Time';
            const hours24 = Math.floor(totalMinutes / 60);
            const minutes = Math.round(totalMinutes % 60);
            const period = hours24 >= 12 ? 'PM' : 'AM';
            let displayHours = hours24 % 12;
            if (displayHours === 0) displayHours = 12; // 0 = 12 AM, 12 = 12 PM
            return `${displayHours}:${minutes.toString().padStart(2, '0')}${period}`;
        };

        const getAppointmentColor = (duration) => {
            // Dark theme optimized colors
            if (duration <= 25) return 'bg-yellow-500/20 border-yellow-400 text-yellow-200';
            if (duration <= 35) return 'bg-blue-500/20 border-blue-400 text-blue-200';
            if (duration <= 45) return 'bg-green-500/20 border-green-400 text-green-200';
            return 'bg-purple-500/20 border-purple-400 text-purple-200';
        };

        const timeStringToMinutes = (time24h) => {
            if (!time24h) return 0;
            const [hours, minutes] = time24h.split(':').map(Number);
            if (isNaN(hours) || isNaN(minutes)) return 0;
            return hours * 60 + minutes;
        };

        const minutesTo24hTime = (totalMinutes) => {
            if (isNaN(totalMinutes) || totalMinutes < 0) return '00:00';
            const hours24 = Math.floor(totalMinutes / 60) % 24; // Use modulo 24 to wrap around midnight
            const minutes = Math.round(totalMinutes % 60);
            return `${hours24.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        };

        // --- CORE LOGIC ---
        function calculateScheduleMetrics() {
             const allScheduledItems = [
                ...state.settings.breaks.map(b => ({ ...b, type: 'break', startMins: timeStringToMinutes(b.start), endMins: timeStringToMinutes(b.end) })),
                ...state.settings.otherTasks.map(t => ({ ...t, type: t.type, startMins: timeStringToMinutes(t.start), endMins: timeStringToMinutes(t.end) })),
                ...state.appointments.map(a => ({ ...a, type: 'appointment', startMins: timeToMinutes(a.start, a.startPeriod), endMins: timeToMinutes(a.end, a.endPeriod) + (a.type === 'appointment' ? state.settings.transitionTime : 0) }))
            ].sort((a, b) => a.startMins - b.startMins);

            const dayStartMins = timeStringToMinutes(state.settings.workDay.startTime);
            
            let lastEnd = dayStartMins + state.settings.setupTime;
            allScheduledItems.forEach(item => {
                lastEnd = Math.max(lastEnd, item.endMins);
            });

            // Calculate Gaps between items
            const gaps = [];
            let lastGapCheck = dayStartMins + state.settings.setupTime;
            allScheduledItems.forEach(item => {
                if (item.startMins > lastGapCheck) {
                    gaps.push({ id: `gap-${lastGapCheck}`, start: lastGapCheck, end: item.startMins, duration: item.startMins - lastGapCheck, type: 'gap' });
                }
                lastGapCheck = Math.max(lastGapCheck, item.endMins);
            });

            // Productivity Calculations
            const totalTreatmentTime = state.appointments.reduce((sum, apt) => sum + apt.duration, 0);
            const billableTaskTime = state.settings.otherTasks.filter(t => t.type === 'billable').reduce((sum, t) => sum + (timeStringToMinutes(t.end) - timeStringToMinutes(t.start)), 0);
            const nonBillableTaskTime = state.settings.otherTasks.filter(t => t.type === 'non-billable').reduce((sum, t) => sum + (timeStringToMinutes(t.end) - timeStringToMinutes(t.start)), 0);
            const totalBreakTime = state.settings.breaks.reduce((sum, br) => sum + (timeStringToMinutes(br.end) - timeStringToMinutes(br.start)), 0);
            
            const totalBillableTime = totalTreatmentTime + billableTaskTime;
            const timeUnavailable = totalBreakTime + nonBillableTaskTime;
            
            // --- Actionable Suggestions & Projections ---
            const suggestions = [];
            let projectedClockOutMins = 0;
            let productivity = 0;

            if (state.settings.productivityTarget > 0 && totalBillableTime > 0) {
                const requiredTotalWorkTime = (totalBillableTime / (state.settings.productivityTarget / 100));
                projectedClockOutMins = dayStartMins + requiredTotalWorkTime + timeUnavailable;
                suggestions.push(`To meet your <b>${state.settings.productivityTarget}% target</b>, you should clock out around <b>${minutesToTime(projectedClockOutMins)}</b>.`);

                const totalWorkTime = lastEnd - dayStartMins;
                const totalProductiveTimePossible = totalWorkTime - timeUnavailable;
                if (totalProductiveTimePossible > 0) {
                     productivity = ((totalBillableTime / totalProductiveTimePossible) * 100).toFixed(1);
                }

            } else {
                 suggestions.push(`Add a billable session to calculate your productivity and target clock-out time.`);
            }

            if (state.patientQueue.length > 0 && gaps.length > 0) {
                const smallestPatientDuration = Math.min(...state.patientQueue.map(p => p.duration));
                const suitableGap = gaps.find(g => g.duration >= smallestPatientDuration);

                if (suitableGap) {
                    suggestions.push(`You have a <b>${suitableGap.duration} min gap</b> at ${minutesToTime(suitableGap.start)} large enough for a queued session.`);
                }
            }
            
            const LATE_THRESHOLD_MINS = 19 * 60; // 7:00 PM
            if (lastEnd > LATE_THRESHOLD_MINS) {
                suggestions.push(`<b>Warning:</b> Your current schedule ends at <b>${minutesToTime(lastEnd)}</b>. Consider moving sessions to an earlier day if possible.`);
            }

            state.schedule = {
                timelineItems: [...allScheduledItems, ...gaps.map(g => ({...g, startMins: g.start, endMins: g.end }))].sort((a,b) => a.startMins - b.startMins),
                totalBillableTime,
                timeUnavailable,
                projectedClockOutMins,
                productivity,
                meetsTarget: projectedClockOutMins > 0 && lastEnd <= projectedClockOutMins,
                suggestions,
                lastEndMins: lastEnd,
                gaps
            };

            // Update productivity calculator end time if needed
            if (projectedClockOutMins > 0) {
                 const projectedTime = minutesToTime(projectedClockOutMins);
                 state.productivityCalculator.endTime = minutesTo24hTime(timeToMinutes(projectedTime.slice(0,-2), projectedTime.slice(-2)))
            }
        }

        // --- RENDER FUNCTIONS ---
        const root = document.getElementById('app-root');

        function render() {
            calculateScheduleMetrics(); // Recalculate everything before rendering

            const { settings, appointments, patientQueue, schedule, notification, isClearModalOpen, isEditModalOpen, editingAppointment } = state;

            // Main App Structure
            root.innerHTML = `
                <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 bg-gray-900 text-gray-300 min-h-screen font-sans printable-area">
                    <div id="notification-container"></div>
                    <div id="modal-container"></div>

                    <div class="no-print">
                        <div class="bg-gray-800 rounded-lg shadow-lg p-4 sm:p-6 mb-6 border border-gray-700">
                            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4">
                                <div>
                                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-100 mb-2 flex items-center gap-2">
                                        <span class="text-yellow-400">${getIcon('Calendar', 28)}</span>
                                        Interactive Therapy Scheduler
                                    </h1>
                                    <p class="text-gray-400">Add patients to the queue, then drag them to the timeline or use the optimizer.</p>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2 shrink-0 w-full sm:w-auto">
                                    <button id="save-settings-btn" class="flex items-center justify-center gap-2 w-full sm:w-auto px-4 py-2 bg-yellow-500 text-gray-900 font-semibold rounded-lg hover:bg-yellow-400">${getIcon('Save')}Save</button>
                                    <button id="print-btn" class="flex items-center justify-center gap-2 w-full sm:w-auto px-4 py-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500">${getIcon('Printer')}Print</button>
                                    <button id="clear-day-btn" class="flex items-center justify-center gap-2 w-full sm:w-auto px-4 py-2 bg-red-800/80 text-red-200 rounded-lg hover:bg-red-700/80">${getIcon('Trash2')}Clear Day</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-6 no-print">
                            <div id="patient-queue-container"></div>
                            <div id="settings-panel-container"></div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div id="day-summary-container"></div>
                            <div id="schedule-timeline-container"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Render child "components"
            renderNotification(notification);
            renderModals(isClearModalOpen, isEditModalOpen, editingAppointment);
            renderPatientQueue(patientQueue);
            renderSettingsPanel(settings);
            renderDaySummary(schedule, appointments, patientQueue, settings);
            renderScheduleTimeline(schedule, settings);
            
            // Add event listeners
            addEventListeners();
        }

        // --- EVENT HANDLERS & LOGIC ---
        function setNotification(message, type) {
            state.notification = { message, type };
            renderNotification(state.notification);
            setTimeout(() => {
                if (state.notification.message === message) {
                    state.notification = { message: '', type: '' };
                    renderNotification(state.notification);
                }
            }, 5000);
        }

        function handleSaveSettings() {
             try {
                const settingsToSave = {...state.settings};
                delete settingsToSave.workDay.startPeriod; // Clean up old properties if they exist
                localStorage.setItem('therapySchedulerSettings', JSON.stringify(settingsToSave));
                localStorage.setItem('therapySchedulerAppointments', JSON.stringify(state.appointments));
                localStorage.setItem('therapySchedulerQueue', JSON.stringify(state.patientQueue));
                setNotification('Settings and schedule saved!', 'success');
            } catch (e) {
                console.error("Failed to save settings to localStorage", e);
                setNotification("Could not save settings. Storage might be full.", 'error');
            }
        }

        function handleClearDay() {
            state.appointments = [];
            state.patientQueue = [];
            state.patientCounter = 1;
            try {
                localStorage.setItem('therapySchedulerAppointments', JSON.stringify([]));
                localStorage.setItem('therapySchedulerQueue', JSON.stringify([]));
                setNotification('Your schedule has been cleared.', 'success');
            } catch (e) {
                console.error("Failed to clear schedule in localStorage", e);
                setNotification("Could not clear schedule data.", 'error');
            }
            state.isClearModalOpen = false;
            render();
        }

        function addPatientToQueue(duration) {
            if (duration < MINIMUM_SCHEDULABLE_DURATION) {
                setNotification(`Duration must be at least ${MINIMUM_SCHEDULABLE_DURATION} minutes.`, 'error');
            } else {
                const newPatient = {
                    id: `p${Date.now()}`,
                    name: `P${state.patientCounter}`,
                    duration
                };
                state.patientCounter += 1;
                state.patientQueue.push(newPatient);
                setNotification(`Patient ${newPatient.name} added to queue.`, 'success');
            }
            render();
        }

        function removePatientFromQueue(id) {
            state.patientQueue = state.patientQueue.filter(p => p.id !== id);
            render();
        }

        function removeAppointmentFromSchedule(appointmentId) {
            const appointmentToRemove = state.appointments.find(a => a.id === appointmentId);
            if (!appointmentToRemove) return;

            state.appointments = state.appointments.filter(a => a.id !== appointmentId);

            if (!state.patientQueue.find(p => p.id === appointmentId)) {
                state.patientQueue.push({ id: appointmentToRemove.id, name: appointmentToRemove.name, duration: appointmentToRemove.duration });
            }
            render();
        }

        function toggleAppointmentComplete(appointmentId) {
            state.appointments = state.appointments.map(apt => apt.id === appointmentId ? { ...apt, completed: !apt.completed } : apt);
            render();
        }

        function handleUpdateAppointmentDuration(appointmentId, newDuration) {
            state.appointments = state.appointments.map(apt => {
                if (apt.id === appointmentId) {
                    const startMins = timeToMinutes(apt.start, apt.startPeriod);
                    const newEndTime = minutesToTime(startMins + newDuration);
                    return {
                        ...apt,
                        duration: newDuration,
                        end: newEndTime.slice(0, -2),
                        endPeriod: newEndTime.slice(-2)
                    };
                }
                return apt;
            });
            setNotification('Session duration updated!', 'success');
            state.isEditModalOpen = false;
            render();
        }

        function autoSchedule() {
            const patientsToSchedule = [
                ...state.patientQueue,
                ...state.appointments.filter(a => !a.completed).map(a => ({ id: a.id, name: a.name, duration: a.duration }))
            ].sort((a, b) => b.duration - a.duration); // Sort longest to shortest

            let currentAppointments = state.appointments.filter(a => a.completed);

            patientsToSchedule.forEach(patient => {
                const dayStartMins = timeStringToMinutes(state.settings.workDay.startTime);
                
                const fixedEvents = [
                    ...state.settings.breaks.map(b => ({ start: timeStringToMinutes(b.start), end: timeStringToMinutes(b.end) })),
                    ...state.settings.otherTasks.map(t => ({ start: timeStringToMinutes(t.start), end: timeStringToMinutes(t.end) })),
                    ...currentAppointments.map(a => ({ start: timeToMinutes(a.start, a.startPeriod), end: timeToMinutes(a.end, a.endPeriod) + state.settings.transitionTime }))
                ].sort((a,b) => a.start - b.start);

                const gaps = [];
                let lastGapCheck = dayStartMins + state.settings.setupTime;
                fixedEvents.forEach(item => {
                    if (item.start > lastGapCheck) {
                        gaps.push({ start: lastGapCheck, end: item.start, duration: item.start - lastGapCheck });
                    }
                    lastGapCheck = Math.max(lastGapCheck, item.end);
                });
                gaps.push({ start: lastGapCheck, end: Infinity, duration: Infinity });

                let bestFitGap = null;
                for (const gap of gaps) {
                    const requiredTime = patient.duration + state.settings.transitionTime;
                    if (gap.duration >= requiredTime) {
                        if (!bestFitGap || gap.duration < bestFitGap.duration) {
                            bestFitGap = gap;
                        }
                    }
                }

                if (bestFitGap) {
                    const placementTime = bestFitGap.start;
                    const startTime = minutesToTime(placementTime);
                    const endTime = minutesToTime(placementTime + patient.duration);
                    const newAppointment = {
                        ...patient,
                        start: startTime.slice(0, -2), startPeriod: startTime.slice(-2),
                        end: endTime.slice(0, -2), endPeriod: endTime.slice(-2),
                        completed: false // Ensures re-optimized appointments are not marked complete
                    };
                    currentAppointments.push(newAppointment);
                }
            });

            state.appointments = currentAppointments.sort((a,b) => timeToMinutes(a.start, a.startPeriod) - timeToMinutes(b.start, b.startPeriod));
            state.patientQueue = [];
            setNotification('Schedule has been optimized!', 'success');
            render();
        }

        function handleAdjustTime(timeId, minutesToAdd) {
            const parts = timeId.split('.');
            let currentValue;
            
            if (parts.length === 2 && parts[0] === 'workDay') {
                currentValue = state.settings.workDay.startTime;
            } else if (parts.length === 3) {
                const [list, itemId, field] = parts;
                const item = state.settings[list].find(item => item.id == itemId);
                if (item) currentValue = item[field];
            } else if(parts[0] === 'productivity') {
                currentValue = state.productivityCalculator.endTime;
            }
            
            if (!currentValue) return;

            let currentMinutes = timeStringToMinutes(currentValue);
            let newMinutes = currentMinutes + minutesToAdd;

            // Wrap around 24 hours (1440 minutes)
            if (newMinutes < 0) {
                newMinutes += 1440;
            }
            newMinutes %= 1440;
            
            const newTime = minutesTo24hTime(newMinutes);

            // Update the state based on the timeId
            if (parts.length === 2 && parts[0] === 'workDay') {
                state.settings.workDay.startTime = newTime;
            } else if (parts.length === 3) {
                const [list, itemId, field] = parts;
                state.settings[list] = state.settings[list].map(item =>
                    item.id == itemId ? { ...item, [field]: newTime } : item
                );
            } else if(parts[0] === 'productivity') {
                state.productivityCalculator.endTime = newTime;
            }

            render();
        }

        function init() {
            try {
                let maxId = 0;
                const savedSettings = localStorage.getItem('therapySchedulerSettings');
                if (savedSettings) {
                    const parsedSettings = JSON.parse(savedSettings);
                    // Backwards compatibility for old AM/PM format
                    if (parsedSettings.workDay.startPeriod) {
                        const { startTime, startPeriod } = parsedSettings.workDay;
                        parsedSettings.workDay = { startTime: minutesTo24hTime(timeToMinutes(startTime, startPeriod)) };

                        parsedSettings.breaks = parsedSettings.breaks.map(b => ({
                            ...b,
                            start: minutesTo24hTime(timeToMinutes(b.start, b.startPeriod)),
                            end: minutesTo24hTime(timeToMinutes(b.end, b.endPeriod))
                        }));
                        delete parsedSettings.breaks.startPeriod;
                        delete parsedSettings.breaks.endPeriod;

                        parsedSettings.otherTasks = parsedSettings.otherTasks.map(t => ({
                            ...t,
                            start: minutesTo24hTime(timeToMinutes(t.start, t.startPeriod)),
                            end: minutesTo24hTime(timeToMinutes(t.end, t.endPeriod))
                        }));
                        delete parsedSettings.otherTasks.startPeriod;
                        delete parsedSettings.otherTasks.endPeriod;
                    }
                    state.settings = parsedSettings;
                }

                const savedAppointments = localStorage.getItem('therapySchedulerAppointments');
                if (savedAppointments) {
                     const parsed = JSON.parse(savedAppointments);
                     state.appointments = parsed;
                     parsed.forEach(a => {
                        const num = parseInt(a.name?.replace('P', ''), 10);
                        if (!isNaN(num) && num > maxId) maxId = num;
                    });
                }
                const savedQueue = localStorage.getItem('therapySchedulerQueue');
                if (savedQueue) {
                    const parsed = JSON.parse(savedQueue);
                    state.patientQueue = parsed;
                    parsed.forEach(p => {
                        const num = parseInt(p.name?.replace('P', ''), 10);
                        if (!isNaN(num) && num > maxId) maxId = num;
                    });
                }
                state.patientCounter = maxId + 1;

            } catch(e) {
                console.error("Failed to load from localStorage", e);
                setNotification("Could not load saved settings.", 'error');
            }
            render();
        }

        function renderNotification(notification) {
            const container = document.getElementById('notification-container');
            if (!notification.message) {
                container.innerHTML = '';
                return;
            }
             const typeClasses = {
                success: "bg-gray-800 border-green-500 text-green-300",
                error: "bg-gray-800 border-red-500 text-red-300",
            };
            const Icon = notification.type === 'success' ? getIcon('CheckCircle', 20) : getIcon('AlertCircle', 20);

            container.innerHTML = `
                <div class="fixed top-5 right-5 z-50 flex items-center gap-3 px-4 py-3 rounded-lg shadow-lg animate-fade-in-down border ${typeClasses[notification.type]}">
                    ${Icon}
                    <span>${notification.message}</span>
                    <button id="dismiss-notification-btn" class="ml-4 p-1 rounded-full hover:bg-white/10">${getIcon('X', 16)}</button>
                </div>
            `;
        }

        function renderModals(isClearModalOpen, isEditModalOpen, appointment) {
             const container = document.getElementById('modal-container');
             container.innerHTML = '';

             if (isClearModalOpen) {
                 container.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6 w-full max-w-md animate-fade-in-down">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-yellow-400">Confirm Clear Day</h2>
                                <button id="close-clear-modal-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700">${getIcon('X', 20)}</button>
                            </div>
                            <div class="text-gray-300 mb-6">Are you sure you want to clear all scheduled appointments and the patient queue? This action cannot be undone.</div>
                            <div class="flex justify-end gap-3">
                                <button id="cancel-clear-btn" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500">Cancel</button>
                                <button id="confirm-clear-btn" class="px-4 py-2 bg-red-800/80 text-red-200 rounded-lg hover:bg-red-700/80">Confirm</button>
                            </div>
                        </div>
                    </div>
                 `;
             }

             if (isEditModalOpen && appointment) {
                  container.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                        <div class="bg-gray-800 border border-gray-700 rounded-lg shadow-xl p-6 w-full max-w-md animate-fade-in-down">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold text-yellow-400">Edit Session: ${appointment.name}</h2>
                                <button id="close-edit-modal-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-700">${getIcon('X', 20)}</button>
                            </div>
                            <div class="mb-6 space-y-2">
                                <label for="duration-input" class="block text-sm font-medium text-gray-300">Adjust session duration (in minutes):</label>
                                <input id="edit-duration-input" type="number" value="${appointment.duration}" class="w-full px-3 py-2 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" />
                            </div>
                            <div class="flex justify-end gap-3">
                                <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500">Cancel</button>
                                <button id="save-edit-btn" class="px-4 py-2 bg-yellow-500 text-gray-900 font-semibold rounded-lg hover:bg-yellow-400">Save Changes</button>
                            </div>
                        </div>
                    </div>
                  `;
             }
        }

        function renderPatientQueue(queue) {
            const container = document.getElementById('patient-queue-container');
            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-lg p-4 border border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4 flex items-center gap-2"><span class="text-yellow-400">${getIcon('Clock', 20)}</span>Patient Queue (${queue.length})</h2>
                    <div class="flex gap-2 mb-2">
                        <input id="patient-duration-input" type="number" placeholder="Duration (min)" class="w-full px-3 py-2 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" min="${MINIMUM_SCHEDULABLE_DURATION}" />
                        <button id="add-patient-btn" class="px-4 py-2 bg-yellow-500 text-gray-900 font-semibold rounded-lg hover:bg-yellow-400 shrink-0">${getIcon('Plus', 16)}</button>
                    </div>
                    <div class="flex justify-between gap-2 mb-4">
                        <button class="add-patient-preset-btn w-full py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600" data-duration="25">+25 min</button>
                        <button class="add-patient-preset-btn w-full py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600" data-duration="30">+30 min</button>
                        <button class="add-patient-preset-btn w-full py-1 text-sm bg-gray-700 text-gray-300 rounded hover:bg-gray-600" data-duration="38">+38 min</button>
                    </div>
                    <div id="patient-list" class="space-y-2 max-h-48 overflow-y-auto p-1 bg-gray-900/50 rounded min-h-[4rem]">
                        ${queue.map(p => `
                            <div draggable="true" class="patient-item flex justify-between items-center p-2 rounded-md shadow-sm cursor-grab active:cursor-grabbing border ${getAppointmentColor(p.duration)}" data-patient-id="${p.id}">
                                <span class="font-semibold">${p.name} (${p.duration} min)</span>
                                <button class="remove-patient-btn p-1 hover:bg-white/10 rounded-full" data-patient-id="${p.id}">${getIcon('Trash2', 14)}</button>
                            </div>
                        `).join('')}
                    </div>
                    <button id="auto-schedule-btn" class="w-full mt-4 py-2 px-4 bg-gray-700 text-yellow-300 font-semibold rounded-lg hover:bg-gray-600 flex items-center justify-center gap-2">${getIcon('Zap')} Optimize Schedule</button>
                </div>
            `;
        }

        function renderTimeInput(value, id) {
            return `
                <div class="flex items-center gap-1">
                    <input type="time" value="${value}" class="time-input w-full px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-1 focus:ring-yellow-500 focus:border-yellow-500" data-id="${id}" />
                    <div class="flex flex-col border border-gray-600 rounded-md overflow-hidden">
                        <button class="time-adjust-btn px-2 text-sm bg-gray-800 text-gray-300 hover:bg-gray-700 border-b border-gray-600" data-id="${id}" data-amount="15" aria-label="Increase time by 15 minutes">+</button>
                        <button class="time-adjust-btn px-2 text-sm bg-gray-800 text-gray-300 hover:bg-gray-700" data-id="${id}" data-amount="-15" aria-label="Decrease time by 15 minutes">-</button>
                    </div>
                </div>
            `;
        }

        function renderSettingsPanel(settings) {
            const container = document.getElementById('settings-panel-container');
            container.innerHTML = `
                <details class="bg-gray-800 rounded-lg shadow-lg p-4 border border-gray-700" open>
                    <summary class="font-semibold text-lg text-gray-200 cursor-pointer">Work Day & Breaks</summary>
                    <div class="mt-4 space-y-4">
                        <div>
                            <h3 class="font-semibold text-gray-400 mb-2">Work Start Time</h3>
                            <div class="p-2 bg-gray-900/50 rounded-lg">
                                ${renderTimeInput(settings.workDay.startTime, 'workDay.startTime')}
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-400 mb-2">Breaks</h3>
                            <div class="space-y-2">
                                ${settings.breaks.map(br => `
                                    <div class="space-y-2 p-2 bg-gray-900/50 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <input type="text" placeholder="Label" value="${br.label}" class="setting-input w-full px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" data-list="breaks" data-id="${br.id}" data-field="label" />
                                            <button class="remove-list-item-btn ml-2 text-red-400 hover:text-red-300 shrink-0" data-list="breaks" data-id="${br.id}">${getIcon('Trash2', 16)}</button>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-500">Start</label>
                                                ${renderTimeInput(br.start, `breaks.${br.id}.start`)}
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-500">End</label>
                                                ${renderTimeInput(br.end, `breaks.${br.id}.end`)}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button id="add-break-btn" class="mt-2 w-full py-1 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">Add Break</button>
                        </div>
                    </div>
                </details>
                <details class="bg-gray-800 rounded-lg shadow-lg p-4 border border-gray-700">
                    <summary class="font-semibold text-lg text-gray-200 cursor-pointer">Other Tasks & Settings</summary>
                    <div class="mt-4 space-y-4">
                        <div>
                            <h3 class="font-semibold text-gray-400 mb-2">Other Scheduled Tasks</h3>
                            <div class="space-y-2">
                            ${settings.otherTasks.map(task => `
                                <div class="space-y-2 p-2 bg-gray-900/50 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <input type="text" placeholder="Label" value="${task.label}" class="setting-input w-full px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" data-list="otherTasks" data-id="${task.id}" data-field="label" />
                                        <button class="remove-list-item-btn ml-2 text-red-400 hover:text-red-300 shrink-0" data-list="otherTasks" data-id="${task.id}">${getIcon('Trash2', 16)}</button>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="text-xs text-gray-500">Start</label>${renderTimeInput(task.start, `otherTasks.${task.id}.start`)}</div>
                                        <div><label class="text-xs text-gray-500">End</label>${renderTimeInput(task.end, `otherTasks.${task.id}.end`)}</div>
                                    </div>
                                    <select class="setting-input w-full px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" data-list="otherTasks" data-id="${task.id}" data-field="type">
                                        <option value="non-billable" ${task.type === 'non-billable' ? 'selected' : ''}>Non-Billable</option>
                                        <option value="billable" ${task.type === 'billable' ? 'selected' : ''}>Billable</option>
                                    </select>
                                </div>
                            `).join('')}
                            </div>
                            <button id="add-task-btn" class="mt-2 w-full py-1 bg-gray-700 text-gray-300 rounded hover:bg-gray-600">Add Task</button>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-400 mb-2">General Settings</h3>
                            <div class="space-y-2 text-gray-300">
                                <div class="flex justify-between items-center"><label>Setup Time (min)</label><input type="number" value="${settings.setupTime}" class="setting-input w-20 px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" data-field="setupTime" /></div>
                                <div class="flex justify-between items-center"><label>Transition Time (min)</label><input type="number" value="${settings.transitionTime}" class="setting-input w-20 px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" data-field="transitionTime" /></div>
                                <div class="flex justify-between items-center"><label>Productivity Target (%)</label><input type="number" value="${settings.productivityTarget}" class="setting-input w-20 px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" data-field="productivityTarget" /></div>
                                <div class="flex justify-between items-center"><label>Workday Duration (hours)</label><input type="number" value="${settings.workdayDurationHours}" class="setting-input w-20 px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" data-field="workdayDurationHours" /></div>
                            </div>
                        </div>
                    </div>
                </details>
            `;
        }

        function renderDaySummary(schedule, appointments, patientQueue, settings) {
             const container = document.getElementById('day-summary-container');
             if (!schedule) { container.innerHTML = ''; return; }
             const patientsSeenCount = appointments.filter(a => a.completed).length;
             container.innerHTML = `
                 <div class="bg-gray-800 rounded-lg shadow-lg p-4 border border-gray-700">
                     <h2 class="text-2xl font-bold text-gray-200 mb-4">Day Summary</h2>
                     <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                         <div><div class="text-2xl sm:text-3xl font-bold ${schedule.meetsTarget ? 'text-green-400' : 'text-gray-300'}">${schedule.projectedClockOutMins > 0 ? minutesToTime(schedule.projectedClockOutMins) : "--:--"}</div><div class="text-sm text-gray-400">Target Clock-Out</div></div>
                         <div><div class="text-2xl sm:text-3xl font-bold text-yellow-400">${Math.floor(schedule.totalBillableTime/60)}h ${schedule.totalBillableTime % 60}m</div><div class="text-sm text-gray-400">Total Billable</div></div>
                         <div><div class="text-2xl sm:text-3xl font-bold text-gray-300">${patientsSeenCount}</div><div class="text-sm text-gray-400">Patients Seen</div></div>
                         <div><div class="text-2xl sm:text-3xl font-bold text-gray-300">${patientQueue.length}</div><div class="text-sm text-gray-400">Unscheduled</div></div>
                     </div>
                      <div class="mt-4 p-3 bg-gray-900/50 border border-gray-700 rounded-lg flex items-start gap-3">
                        <span class="text-yellow-400 mt-1 flex-shrink-0">${getIcon('BrainCircuit', 20)}</span>
                         <div>
                             <h4 class="font-semibold text-yellow-400">Actionable Insights</h4>
                             ${schedule.suggestions.map(s => `<p class="text-sm text-gray-300">${s.replace(/<b>/g, '<b class="text-yellow-300">')}</p>`).join('')}
                         </div>
                     </div>
                     ${schedule.timeUnavailable !== undefined ? renderProductivityCalculator(schedule, settings) : ''}
                 </div>
             `;
        }

        function renderProductivityCalculator(schedule, settings) {
            const { extraMinutes, endTime } = state.productivityCalculator;

            const dayStartMins = timeStringToMinutes(settings.workDay.startTime);
            const totalBillableTime = schedule.totalBillableTime;
            const timeUnavailable = schedule.timeUnavailable;
            const whatIfEndTimeMins = timeStringToMinutes(endTime);
            const whatIfTotalWorkTime = whatIfEndTimeMins - dayStartMins;
            const whatIfProductiveTimePossible = whatIfTotalWorkTime - timeUnavailable;

            const productivityAtNewTime = whatIfProductiveTimePossible > 0
                ? ((totalBillableTime / whatIfProductiveTimePossible) * 100).toFixed(1)
                : "0.0";

            const addedMinutes = parseInt(extraMinutes) || 0;
            const newTotalBillableTime = totalBillableTime + addedMinutes;
            const productivityWithExtraMinutes = whatIfProductiveTimePossible > 0
                ? ((newTotalBillableTime / whatIfProductiveTimePossible) * 100).toFixed(1)
                : "0.0";

            return `
                 <details class="mt-4 bg-gray-900/50 rounded-lg p-3 border border-gray-700">
                    <summary class="font-semibold text-gray-300 cursor-pointer flex items-center gap-2">${getIcon('TrendingUp')} Productivity Calculator</summary>
                    <div class="mt-4 space-y-4 pt-4 border-t border-gray-700">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-400">If I clock out at...</label>
                            ${renderTimeInput(endTime, 'productivity.endTime')}
                            <p class="text-sm text-gray-300 mt-2">Your productivity would be: <strong class="text-lg text-yellow-400">${productivityAtNewTime}%</strong></p>
                        </div>
                        <hr class="border-gray-700"/>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-400">And I add an extra...</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="extra-minutes-input" value="${extraMinutes}" class="w-full px-2 py-1 bg-gray-700 border-gray-600 text-gray-200 rounded-md focus:ring-yellow-500 focus:border-yellow-500" placeholder="e.g., 30" />
                                <span class="text-sm text-gray-500">billable mins</span>
                            </div>
                            <p class="text-sm text-gray-300">Your new productivity would be: <strong class="text-lg text-yellow-400">${productivityWithExtraMinutes}%</strong> (at the time specified above)</p>
                        </div>
                    </div>
                </details>
            `;
        }

        function renderScheduleTimeline(schedule, settings) {
            const container = document.getElementById('schedule-timeline-container');
            if(!schedule) { container.innerHTML = ''; return; }

            const dayStartMins = timeStringToMinutes(settings.workDay.startTime);
            const totalDayDuration = settings.workdayDurationHours * 60;
            const startHour = Math.floor(dayStartMins / 60);
            const endHour = startHour + settings.workdayDurationHours;

            let timeMarkersHTML = '';
            for (let hour = startHour; hour <= endHour; hour++) {
                const hourMins = hour * 60;
                const top = ((hourMins - dayStartMins) / totalDayDuration) * 100;
                if (top >= 0 && top <= 100) {
                    timeMarkersHTML += `
                        <div class="absolute w-full" style="top: ${top}%">
                            <span class="text-xs text-gray-500 absolute -left-12 transform -translate-y-1/2">${hour % 12 || 12}:00 ${hour < 12 || hour >= 24 ? 'AM' : 'PM'}</span>
                            <div class="border-t border-gray-700"></div>
                        </div>
                    `;
                }
            }

            const timelineItemsHTML = schedule.timelineItems.map(item => {
                 if (totalDayDuration <= 0) return '';
                 const top = ((item.startMins - dayStartMins) / totalDayDuration) * 100;
                 const height = ((item.endMins - item.startMins) / totalDayDuration) * 100;
                 if (height <= 0) return '';

                 let content = '';

                 switch(item.type) {
                     case 'appointment':
                        content = `
                            <div draggable="true" class="timeline-appointment-item relative group w-[90%] left-[5%] p-1 rounded-md text-xs cursor-pointer h-full flex flex-col justify-center border ${getAppointmentColor(item.duration)} ${item.completed ? 'opacity-60' : ''}" data-id="${item.id}">
                                <strong class="${item.completed ? 'line-through' : ''}">${item.name} (${item.duration}m)</strong>
                                <span class="text-[10px] ${item.completed ? 'line-through' : ''}">${minutesToTime(item.startMins)}-${minutesToTime(item.endMins)}</span>
                                <div class="absolute top-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button class="edit-appointment-btn p-0.5 bg-gray-900/50 rounded-full hover:bg-gray-900/80" data-id="${item.id}">${getIcon('Edit', 14)}</button>
                                    <button class="toggle-complete-btn p-0.5 bg-gray-900/50 rounded-full hover:bg-gray-900/80" data-id="${item.id}">${getIcon('CheckCircle', 14)}</button>
                                    <button class="remove-appointment-btn p-0.5 bg-gray-900/50 rounded-full hover:bg-gray-900/80" data-id="${item.id}">${getIcon('Trash2', 14)}</button>
                                </div>
                                ${item.completed ? `<div class="absolute top-1 right-1 p-0.5 bg-gray-900/50 rounded-full group-hover:opacity-0">${getIcon('CheckCircle', 14)}</div>` : ''}
                            </div>`;
                         break;
                     case 'break':
                         content = `<div class="w-[90%] left-[5%] p-1 rounded-md bg-gray-700/50 border-gray-600 text-gray-300 text-xs h-full flex flex-col justify-center"><span class="text-yellow-400">${getIcon('Coffee', 14)}</span><strong>${item.label}</strong><span class="text-[10px]">${minutesToTime(item.startMins)}-${minutesToTime(item.endMins)}</span></div>`;
                         break;
                     case 'billable':
                     case 'non-billable':
                         content = `<div class="w-[90%] left-[5%] p-1 rounded-md bg-gray-700/50 border-gray-600 text-gray-300 text-xs h-full flex flex-col justify-center"><span class="text-yellow-400">${getIcon('Briefcase', 14)}</span><strong>${item.label}</strong> (${item.type})<span class="text-[10px]">${minutesToTime(item.startMins)}-${minutesToTime(item.endMins)}</span></div>`;
                         break;
                     case 'gap':
                         content = `<div class="timeline-gap w-[90%] left-[5%] rounded-md border-2 border-dashed border-gray-700 hover:bg-yellow-500/10 hover:border-yellow-400 transition-colors flex justify-center items-center text-gray-500 text-xs text-center h-full" data-start="${item.start}" data-duration="${item.duration}">Drop Here<br/>(${item.duration} min)</div>`;
                         break;
                 }

                return `<div style="top: ${top}%; height: ${height}%;" class="absolute w-full">${content}</div>`;
            }).join('');

            container.innerHTML = `
                <div class="bg-gray-800 rounded-lg shadow-lg p-4 border border-gray-700">
                    <h2 class="text-xl font-semibold text-gray-200 mb-4">Visual Schedule</h2>
                    <div id="timeline-droppable" class="relative min-h-[75vh] bg-gray-900/50 rounded ml-10 sm:ml-14 py-2">
                        ${timeMarkersHTML}
                        ${timelineItemsHTML}
                    </div>
                </div>
            `;
        }

        function addEventListeners() {
            // Use event delegation on the root element for dynamic content
            root.addEventListener('click', (e) => {
                // Main Buttons
                if (e.target.closest('#save-settings-btn')) handleSaveSettings();
                if (e.target.closest('#print-btn')) window.print();
                if (e.target.closest('#clear-day-btn')) { state.isClearModalOpen = true; render(); }
                
                // Notification
                if (e.target.closest('#dismiss-notification-btn')) { state.notification = { message: '', type: '' }; renderNotification(state.notification); }
                
                // Modals
                if (e.target.closest('#close-clear-modal-btn') || e.target.closest('#cancel-clear-btn')) { state.isClearModalOpen = false; render(); }
                if (e.target.closest('#confirm-clear-btn')) handleClearDay();
                if (e.target.closest('#close-edit-modal-btn') || e.target.closest('#cancel-edit-btn')) { state.isEditModalOpen = false; render(); }
                if (e.target.closest('#save-edit-btn')) {
                    const input = document.getElementById('edit-duration-input');
                    const newDuration = parseInt(input.value);
                    if (!isNaN(newDuration) && newDuration > 0) {
                        handleUpdateAppointmentDuration(state.editingAppointment.id, newDuration);
                    }
                }

                // Patient Queue
                if (e.target.closest('#add-patient-btn')) {
                    const input = document.getElementById('patient-duration-input');
                    const duration = parseInt(input.value);
                    if (duration > 0) { addPatientToQueue(duration); input.value = ''; }
                }
                if (e.target.classList.contains('add-patient-preset-btn')) {
                    addPatientToQueue(parseInt(e.target.dataset.duration));
                }
                if (e.target.closest('.remove-patient-btn')) {
                    removePatientFromQueue(e.target.closest('.remove-patient-btn').dataset.patientId);
                }
                if (e.target.closest('#auto-schedule-btn')) autoSchedule();

                // Timeline Buttons
                 if (e.target.closest('.edit-appointment-btn')) {
                    const id = e.target.closest('.edit-appointment-btn').dataset.id;
                    state.editingAppointment = state.appointments.find(a => a.id === id);
                    state.isEditModalOpen = true;
                    render();
                }
                 if (e.target.closest('.toggle-complete-btn')) {
                    toggleAppointmentComplete(e.target.closest('.toggle-complete-btn').dataset.id);
                }
                if (e.target.closest('.remove-appointment-btn')) {
                    removeAppointmentFromSchedule(e.target.closest('.remove-appointment-btn').dataset.id);
                }

                // Settings Panel
                 if (e.target.closest('#add-break-btn')) {
                     state.settings.breaks.push({ id: `break-${Date.now()}`, start: '12:00', end: '12:30', label: 'New Break'});
                     render();
                 }
                  if (e.target.closest('#add-task-btn')) {
                     const defaultStart = '15:00';
                     const defaultEnd = minutesTo24hTime(timeStringToMinutes(defaultStart) + MINIMUM_SCHEDULABLE_DURATION);
                     state.settings.otherTasks.push({ id: `task-${Date.now()}`, start: defaultStart, end: defaultEnd, label: 'New Task', type: 'non-billable'});
                     render();
                 }
                 if (e.target.closest('.remove-list-item-btn')) {
                     const { list, id } = e.target.closest('.remove-list-item-btn').dataset;
                     state.settings[list] = state.settings[list].filter(item => item.id != id);
                     render();
                 }
                
                // Time adjustment buttons
                if (e.target.classList.contains('time-adjust-btn')) {
                    const { id, amount } = e.target.dataset;
                    handleAdjustTime(id, parseInt(amount));
                }
            });

            // Handle keydown events for Enter key submissions
            root.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (e.target.id === 'patient-duration-input') {
                        const duration = parseInt(e.target.value);
                        if (duration > 0) { addPatientToQueue(duration); e.target.value = ''; }
                    }
                    if (e.target.id === 'edit-duration-input') {
                        const newDuration = parseInt(e.target.value);
                        if (!isNaN(newDuration) && newDuration > 0) {
                            handleUpdateAppointmentDuration(state.editingAppointment.id, newDuration);
                        }
                    }
                }
            });

            root.addEventListener('change', (e) => {
                if(e.target.classList.contains('setting-input')) {
                    const { list, id, field } = e.target.dataset;
                    const value = e.target.type === 'number' ? parseInt(e.target.value) || 0 : e.target.value;
                    if(list && id && field) {
                         state.settings[list] = state.settings[list].map(item => item.id == id ? { ...item, [field]: value } : item);
                    } else if (field) {
                        state.settings[field] = value;
                    }
                    render();
                }
                if(e.target.id === 'extra-minutes-input') {
                    state.productivityCalculator.extraMinutes = e.target.value;
                    render();
                }
            });

             root.addEventListener('input', (e) => {
                if (e.target.classList.contains('time-input')) {
                    const id = e.target.dataset.id;
                    const value = e.target.value;
                    const parts = id.split('.');
                    if (parts.length === 2 && parts[0] === 'workDay') {
                        state.settings.workDay.startTime = value;
                    } else if (parts.length === 3) {
                         const [list, itemId, field] = parts;
                         state.settings[list] = state.settings[list].map(item => item.id == itemId ? { ...item, [field]: value } : item);
                    } else if(parts[0] === 'productivity') {
                        state.productivityCalculator.endTime = value;
                    }
                    render();
                }
            });

            // Drag and Drop
            root.addEventListener('dragstart', (e) => {
                 if (e.target.closest('.patient-item')) {
                    const patientId = e.target.closest('.patient-item').dataset.patientId;
                    state.draggedPatient = state.patientQueue.find(p => p.id === patientId);
                } else if (e.target.closest('.timeline-appointment-item')) {
                     const appointmentId = e.target.closest('.timeline-appointment-item').dataset.id;
                     state.draggedPatient = state.appointments.find(a => a.id === appointmentId);
                }
            });

            root.addEventListener('dragover', (e) => {
                 if (e.target.closest('.timeline-gap') || e.target.closest('#timeline-droppable')) {
                     e.preventDefault();
                 }
            });

            root.addEventListener('drop', (e) => {
                if (e.target.closest('.timeline-gap')) {
                    e.preventDefault();
                    const patient = state.draggedPatient;
                    const gapEl = e.target.closest('.timeline-gap');
                    const gap = {
                        start: parseInt(gapEl.dataset.start),
                        duration: parseInt(gapEl.dataset.duration)
                    };
                    const requiredTime = patient.duration + state.settings.transitionTime;
                    if (patient && gap.duration >= requiredTime) {
                        // Remove from both potential sources
                        state.patientQueue = state.patientQueue.filter(p => p.id !== patient.id);
                        state.appointments = state.appointments.filter(a => a.id !== patient.id);

                        const startTime = minutesToTime(gap.start);
                        const endTime = minutesToTime(gap.start + patient.duration);
                        const newAppointment = {
                            ...patient,
                            start: startTime.slice(0, -2), startPeriod: startTime.slice(-2),
                            end: endTime.slice(0,-2), endPeriod: endTime.slice(-2),
                            completed: false
                        };
                        state.appointments.push(newAppointment);
                        state.appointments.sort((a,b) => timeToMinutes(a.start, a.startPeriod) - timeToMinutes(b.start, b.startPeriod));
                        render();
                    } else if (patient) {
                        setNotification(`Session (${patient.duration} min) does not fit in this gap (${gap.duration} min).`, 'error');
                    }
                } else if (e.target.closest('#timeline-droppable')) {
                    e.preventDefault();
                }
                 state.draggedPatient = null;
            });
        }
        
        // Initial Load
        init();
    </script>
</body>
</html>
